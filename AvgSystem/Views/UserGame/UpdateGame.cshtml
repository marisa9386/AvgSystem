@{
    Layout = "~/Views/Shared/_User.cshtml";
    ViewBag.Title = "文字冒险模拟器";
}

<meta id="pageLabel" data-page="UserGame" />
<style>
    body {
        background-color: #eee;
        height: 100%;
    }
</style>
<link href="~/res/UI/UIContent/js/functiondatepick/css/foundation-datepicker.css" rel="stylesheet" type="text/css">
<script src="~/res/UI/UIContent/js/functiondatepick/js/foundation-datepicker.js"></script>
<script src="~/res/UI/UIContent/js/functiondatepick/js/locales/foundation-datepicker.zh-CN.js"></script>

<!--右侧正文-->
<div class="col-md-9">
    <div class="rightContent" style="min-height: 800px;">
        <div class="cvBox">
            <div class="sepDiv">
                <div class="row">
                    <div class="col-md-6">
                        <h3 style="line-height: 32px">基本信息</h3>
                    </div>
                    <div class="col-md-6" style="text-align: right">
                        <a class="btn btn-default" href="javascript:void(0)" style="display:none;" id="btnSave" onclick="saveGameInfo()"><i class="fa fa-refresh"></i>保存</a>
                        <a class="btn btn-default" style="display:none;" href="javascript:void(0)" onclick="pubGame()" id="btnPubGame"><i class="fa fa-edit"></i>发布/撤销</a>
                        <a class="btn btn-default" href="@Url.Action("Index", "UserGame")" ><i class="fa fa-reply"></i> 返回</a>
                    </div>
                </div>
            </div>
            <div class="cvUserInfo">
                <div class="row">
                    <div class="col-md-12">
                        <div class="row">
                            <div class="col-md-12">
                                <span class="font555 fontSize14">标题：</span>
                                <input id="gameTitle" class="editInput" maxlength="40" type="text" value="" style="width: 70%" placeholder="字数限制40">
                            </div>
                        </div>
                        <div class="row">
                            <div class="height10"></div>
                            <div class="col-md-6">
                                <span class="font555 fontSize14">价格：</span>
                                <input id="gameCost" maxlength="10" class="editInput" type="text"  onkeyup="clearNoNum(this)" value="" style="width: 200px" placeholder="最小价格为0.0001NAS">
                            </div>
                            <div class="col-md-6">
                                <span class="font555 fontSize14">开始章节关键字：</span>
                                <input id="gameStartSection" class="editInput" maxlength="10" value="" style="width: 200px" placeholder="字数限制10">
                            </div>
                            
                        </div>
                        <div class="row">
                            <div class="height10"></div>
                            <div class="col-md-6">
                                <span class="font555 fontSize14">发布日期：</span>
                                <input id="gamePubTime" class="editInput" type="text" style="width: 200px" readonly>
                                <input id="isPub" style="display:none;" type="text">
                            </div>
                        </div>
                    </div>


                    </div>
            </div>

            <div class="sepDiv">
                <div class="row">
                    <div class="col-md-6">
                        <h3 style="line-height: 32px">介绍</h3>
                    </div>
                </div>
            </div>
            <div class="cvSelfCom">
                <div class="row">
                    <div class="col-md-12">
                        <div>
                            <span class="fontSize14 font555">
                                <!--自我评价内容请渲染在这里 请勿换行-->
                                <textarea id="gameDesc" class="form-control" rows="5" cols="20" maxlength="200" placeholder="请填写介绍(字数限制200)" style="width: 100%"></textarea>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            


            <div class="height20"></div>


        </div>
        <div class="height30"></div>
    </div>
</div>

<!--<script src="~/Content/js/yifanToast.js"></script>-->
<script type="text/javascript">
    var GameId = @ViewBag.GameId;
    var actmsg = "@ViewBag.actmsg";
   

    //添加证书
    function addCer() {
        var form = '  <div style="border:1px solid #ddd;padding: 15px">'+
                '                                    <form class="form-horizontal">'+
                '                                        <div class="form-group">'+
                '                                            <label class="col-sm-2 control-label font555 fontSize14">证书名称</label>'+
                '                                            <div class="col-sm-10">'+
                '                                                <input type="text" class="form-control" id="cerName" maxlength="50" placeholder="请填写证书等级">' +
                '                                            </div>'+
                '                                        </div>'+
                '                                        <div class="form-group">'+
                '                                            <label class="col-sm-2 control-label font555 fontSize14">证书等级</label>'+
                '                                            <div class="col-sm-10">'+
                '                                                <input type="text" class="form-control" id="cerLevel" maxlength="50" placeholder="请填写证书等级">' +
                '                                            </div>'+
                '                                        </div>' +
                '                                        <div class="form-group">' +
                '                                            <label class="col-sm-2 control-label font555 fontSize14">获得时间</label>' +
                '                                            <div class="col-sm-10">' +
                '                                                <input type="text" class="editInput" id="cerIsuDT" readonly="readonly" placeholder="获得时间 :如2015-06-01">' +
                '                                            </div>' +
                '                                        </div>' +
                '                                        <div style="text-align: center;margin-top: 10px">'+
                '                                            <a class="btn btn-default confirmButton" style="width: 60px" href="javascript:void(0)" onclick="saveCer()">确定</a>' +
                '                                        </div>'+
                '                                    </form>'+
                '                                </div>';
        $('#certificateEdit').html(form);

        $("#cerIsuDT").fdatepicker({
            format: 'yyyy-mm-dd'
        });

    }
    var saveCerUrl = '@Url.Action("SaveCer", "ResumePage")';
    //保存证书
    function saveCer() {

        var cerName = $("#cerName").val();
        var cerLevel = $("#cerLevel").val();
        var cerIsuDT = $("#cerIsuDT").val();
        $.ajax({
            type: "POST",
            url: saveCerUrl,//填写保存培训经验基本信息接口
            dataType : "json",
            contentType: 'application/x-www-form-urlencoded;charset=UTF-8',
            cache: false,
            data: {
                'RId': Id,
                'Name': cerName,
                'Level': cerLevel,
                'IsuDT': cerIsuDT
            },
            success:function(data) {
                if (data.state == "success") {
                    var data = data.data;

                    $("#appendCertificateEdit").append('<div class="row" style="margin-bottom: 20px" id="cer_' + data.Id + '">\
                        <div class="col-md-10" style="line-height:34px;">\
                            <div class="row">\
                                <div class="col-md-6">\
                                    <span class="fontSize14">' + cerName + '</span>\
                                </div>\
                                <div class="col-md-3">\
                                    <span class="fontSize14">' + cerLevel + '</span>\
                                </div>\
                                <div class="col-md-3">\
                                    <span class="fontSize14">' + cerIsuDT + '</span>\
                                </div>\
                            </div>\
                        </div>\
                        <div class="col-md-2">\
                            <button onclick="delCer(\'' + data.Id + '\')" class="btn btn-danger" style="background-color: #fff;color:#e35b5a">\
                                <i class="fa fa-trash"></i> 删除\
                            </button>\
                        </div>\
                    </div>');


                    $('#certificateEdit').html("");
                }else{
                    yifanToast("保存失败，请重试",'toast-md');
                }
            },
            error : function() {


                yifanToast("无法连接服务器",'toast-md');
            }
        });

    }
    var delCerUrl = '@Url.Action("DelCer", "ResumePage")';
    //删除证书
    function delCer(id) {
        $.ajax({
            type: "POST",
            url: delCerUrl,//填写删除证书接口
            dataType : "json",
            contentType: 'application/x-www-form-urlencoded;charset=UTF-8',
            cache: false,
            data:{
                'id':id
            },
            success:function(data) {
                if (data.state == "success") {
                    //如果在后端删除成功，那么前端也会删除相应的div
                    yifanToast("删除成功", 'toast-md');
                    $('#cer_' + id).remove();

                }else{
                    yifanToast("删除失败，请重试",'toast-md');
                }
            },
            error : function() {
                yifanToast("无法连接服务器",'toast-md');
            }
        });
    }




    //加载简历
    function loadResume(data) {
        //var data = { Cv: null, JobExps: null, TrainExps: null, Edu: null, Cers: null };
        if (data) {
            if (data.Cv) {
                /*Username，UserSex，UserAge，UserAddress，UserTel，UserEmail，Logo SkillContent SelfContent*/
                $.each(data.Cv, function (key, val) {
                    $('.cvUserInfo,.cvSkill,.cvSelfCom').find('#cv' + key).val(data.Cv[key]);
                });
                //alert(data.Cv.UserBirthDate);
                if (data.Cv.UserBirthDate != "" && data.Cv.UserBirthDate != null)
                {
                    //alert(2);
                    $('#cvUserBirthDate').val(data.Cv.UserBirthDate.substring(0, 10));
                }

                if (data.Cv.Logo != "" && data.Cv.Logo != null){
                    $('#cvLogoImg').attr('src', "/" + data.Cv["Logo"]);
                }
                // $('#cvLogoImg').attr('src', "/File/GetFile?keyValue=" + data.Cv["Logo"]);
            }


            if (data.Cers) {
                var $cvCer = $('.cvCer');
                for (var i = 0; i < data.Cers.length; i++) {
                    var cer = data.Cers[i];
                    var IsuDT = "";
                    if (cer.IsuDT != "" && cer.IsuDT != null) {
                        IsuDT = cer.IsuDT.substring(0, 10)
                    }
                    //Id Name Level
                    $cvCer.append('<div class="row" style="margin-bottom: 20px" id="cer_'+cer.ID+'">\
                        <div class="col-md-10" style="line-height:34px;">\
                            <div class="row">\
                                <div class="col-md-6">\
                                    <span class="fontSize14">'+cer.Name+'</span>\
                                </div>\
                                <div class="col-md-3">\
                                    <span class="fontSize14">' + cer.CerLevel + '</span>\
                                </div>\
                                <div class="col-md-3">\
                                    <span class="fontSize14">' + IsuDT + '</span>\
                                </div>\
                            </div>\
                        </div>\
                        <div class="col-md-2">\
                            <button onclick="delCer(\'' + cer.ID + '\')" class="btn btn-danger" style="background-color: #fff;color:#e35b5a">\
                                <i class="fa fa-trash"></i> 删除\
                            </button>\
                        </div>\
                    </div>');

                }
            }
        }
    }
    var getResumeUrl = '@Url.Action("GetResume", "ResumePage")';

    $(function () {

        if (actmsg == "update"){
            loadGameDetail();
        }
        else{
            $("#btnSave").show();
            $("#btnPubGame").hide();
        }
    });

    var loadGameDetail = function () {
        var args = JSON.stringify([GameId]);
        onSimulateCallClick(mainContractAddress, "getOwnGameInfo", args, function (e) {
            var item = JSON.parse(e.result);
            if (item.title) {


                $("#gameTitle").val(item.title);
                $("#gameCost").val(item.cost);
                $("#gameStartSection").val(item.startSection);
                $("#gamePubTime").val(timeStamp2String2(item.pubTime));
                $("#gameDesc").val(item.desc);
                //loadInfo("gameDesc", item.desc);
                $("#btnSave").show();
                $("#isPub").val(item.isPub);

                if( item.isPub == 1){
                    $("#btnPubGame").show();
                    loadInfoHtml("btnPubGame","<i class='fa fa-edit'></i>撤销");
                    //<i class="fa fa-edit"></i>发布/撤销
                } else {
                    $("#btnPubGame").show();
                    loadInfoHtml("btnPubGame","<i class='fa fa-edit'></i>发布");
                }

            } else {

            }

        });

    };

    function saveGameInfo() {

        //
        var title = $("#gameTitle").val();
        var cost = $("#gameCost").val();
        var startSection = $("#gameStartSection").val();
        var desc = $("#gameDesc").val();
        var param = {};
        var method = "";
        if( actmsg == "update")
        {
            method = "updateGameInfo";
            param = {id:GameId,title:title,desc:desc,cost:cost,startSection:startSection};
        }
        else {
            method = "addGameInfo";
            param = {title:title,desc:desc,cost:cost,startSection:startSection};
        }

        var args = JSON.stringify([param]);
        newTransaction(mainContractAddress, 0, method, args, function(t) {
            layer.alert("保存成功", function (index) {
                layer.close(index);
                window.location.href = '@Url.Action("Index", "UserGame")';
            });
        });
    }


    function pubGame() {
    
        var isPub = $("#isPub").val();
        if( actmsg == "update" && isPub == 0)
        {
            param = {id:GameId,isPub:1};
        }
        else if ( actmsg == "update" && isPub == 1){
            param = {id:GameId,isPub:0};
        }
        var args = JSON.stringify([param]);
        newTransaction(mainContractAddress, 0, "pubGameInfo", args, function(t) {
            layer.alert("提交成功", function (index) {
                layer.close(index);
                window.location.href = '@Url.Action("Index", "UserGame")';
            });
        });
    
    }



    function clearNoNum(obj){
        obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
        obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的
        obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d\d\d\d).*$/,'$1$2.$3');//只能输入两个小数
        if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            obj.value= parseFloat(obj.value);
        }
    }

    function loadInfoHtml(id, content) {
        if (id == "" || id == null || id == "undefined") {
            return;
        }
        else {
            if (content != null && content != "null") {
                $("#" + id).html(content);
            }
            else {
                $("#" + id).html('');
            }
        }
    }
</script>